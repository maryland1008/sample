DateInput=(function(a){function b(c,d){if(typeof(d)!="object"){d={}}a.extend(this,b.DEFAULT_OPTS,d);this.input=a(c);this.bindMethodsToObj("show","hide","hideIfClickOutside","keydownHandler","selectDate");this.build();this.selectDate();this.hide()}b.DEFAULT_OPTS={month_names:["January","February","March","April","May","June","July","August","September","October","November","December"],short_month_names:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],short_day_names:["S","M","T","W","T","F","S"],start_of_week:0};b.prototype={build:function(){this.monthNav=a('<select class="month_nav" title="Change the month"></select>');this.monthNav.change(this.bindToObj(function(){this.moveMonthTo(this.monthNav.children("option:selected").val())}));this.yearNav=a('<select class="year_nav" title="Change the year"></select>');this.yearNav.change(this.bindToObj(function(){this.moveYearTo(this.yearNav.children("option:selected").val())}));var c=a('<div class="nav"></div>').append(this.monthNav,this.yearNav);var d="<table><thead><tr>";a(this.adjustDays(this.short_day_names)).each(function(){d+="<th>"+this+"</th>"});d+='</tr></thead><tbody></tbody></table><div class="nav-bottom"><span class="button_today">Today</span><span class="button_close">Close</span></div>';this.dateSelector=this.rootLayers=a('<div class="date_selector"></div>').append(c,d).insertAfter(this.input);a(".button_today",this.dateSelector).click(this.bindToObj(function(){this.selectToday()}));a(".button_close",this.dateSelector).click(this.bindToObj(function(){this.hide()}));if(a.browser.msie&&a.browser.version<7){this.ieframe=a('<iframe class="date_selector_ieframe" frameborder="0" src="#"></iframe>').insertBefore(this.dateSelector);this.rootLayers=this.rootLayers.add(this.ieframe);a(".button",c).mouseover(function(){a(this).addClass("hover")});a(".button",c).mouseout(function(){a(this).removeClass("hover")})}this.tbody=a("tbody",this.dateSelector);this.input.change(this.bindToObj(function(){this.selectDate()}));this.selectDate()},selectToday:function(){this.selectDate(new Date());this.changeInput(this.selectedDateString);this.hide()},selectMonth:function(d){var m=new Date(d.getFullYear(),d.getMonth(),1);if(!this.currentMonth||!(this.currentMonth.getFullYear()==m.getFullYear()&&this.currentMonth.getMonth()==m.getMonth())){this.currentMonth=m;var n=this.rangeStart(d),c=this.rangeEnd(d);var h=this.daysBetween(n,c);var f="";for(var g=0;g<=h;g++){var k=new Date(n.getFullYear(),n.getMonth(),n.getDate()+g,12,0);if(this.isFirstDayOfWeek(k)){f+="<tr>"}if(k.getMonth()==d.getMonth()){f+='<td class="selectable_day" date="'+this.dateToString(k)+'">'+k.getDate()+"</td>"}else{f+='<td class="unselected_month" date="'+this.dateToString(k)+'">'+k.getDate()+"</td>"}if(this.isLastDayOfWeek(k)){f+="</tr>"}}this.tbody.empty().append(f);this.monthNav.children().remove();this.monthNav.css("width","1px");for(var l in this.month_names){this.monthNav.append(a("<option></option>").val(l).html(this.month_names[l]))}this.monthNav.children().get(d.getMonth()).selected=true;this.monthNav.css("width","7.5em");this.yearNav.children().remove();this.yearNav.css("width","1px");for(var e=this.currentMonth.getFullYear()-20;e<=this.currentMonth.getFullYear()+5;e++){this.yearNav.append(a("<option></option>").val(e).html(e).attr("selected",e==this.currentMonth.getFullYear()))}this.yearNav.css("width","4.5em");a(".selectable_day",this.tbody).click(this.bindToObj(function(i){this.changeInput(a(i.target).attr("date"))}));a("td[date='"+this.dateToString(new Date())+"']",this.tbody).addClass("today");a("td.selectable_day",this.tbody).mouseover(function(){a(this).addClass("hover")});a("td.selectable_day",this.tbody).mouseout(function(){a(this).removeClass("hover")})}a(".selected",this.tbody).removeClass("selected");a('td[date="'+this.selectedDateString+'"]',this.tbody).addClass("selected")},selectDate:function(c){if(typeof(c)=="undefined"){c=this.stringToDate(this.input.val())}if(!c){c=new Date()}this.selectedDate=c;this.selectedDateString=this.dateToString(this.selectedDate);this.selectMonth(this.selectedDate)},changeInput:function(c){this.input.val(c).change();this.hide()},show:function(){this.rootLayers.css("display","block");a([window,document.body]).click(this.hideIfClickOutside);this.input.unbind("focus",this.show);a(document.body).keydown(this.keydownHandler);this.setPosition()},hide:function(){this.rootLayers.css("display","none");a([window,document.body]).unbind("click",this.hideIfClickOutside);this.input.focus(this.show);a(document.body).unbind("keydown",this.keydownHandler)},hideIfClickOutside:function(c){if(c.target!=this.input[0]&&!this.insideSelector(c)){this.hide()}},insideSelector:function(c){var d=this.dateSelector.position();d.right=d.left+this.dateSelector.outerWidth();d.bottom=d.top+this.dateSelector.outerHeight();return c.pageY<d.bottom&&c.pageY>d.top&&c.pageX<d.right&&c.pageX>d.left},keydownHandler:function(c){switch(c.keyCode){case 9:case 27:this.hide();return;break;case 13:this.changeInput(this.selectedDateString);break;case 33:this.moveDateMonthBy(c.ctrlKey?-12:-1);break;case 34:this.moveDateMonthBy(c.ctrlKey?12:1);break;case 38:this.moveDateBy(-7);break;case 40:this.moveDateBy(7);break;case 37:this.moveDateBy(-1);break;case 39:this.moveDateBy(1);break;default:return}c.preventDefault()},stringToDate:function(c){var d;if(d=c.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4,4})$/)){return new Date(d[3],(d[1]-1),d[2],12,0)}else{return null}},dateToString:function(e){var c=parseInt(e.getMonth())<9?"0"+(e.getMonth()+1):(e.getMonth()+1);var f=parseInt(e.getDate())<10?"0"+e.getDate():e.getDate();return c+"/"+f+"/"+e.getFullYear()},setPosition:function(){var c=this.input.offset();this.rootLayers.css({top:c.top+this.input.outerHeight(),left:c.left});if(this.ieframe){this.ieframe.css({width:this.dateSelector.outerWidth(),height:this.dateSelector.outerHeight()})}},moveDateBy:function(d){var c=new Date(this.selectedDate.getFullYear(),this.selectedDate.getMonth(),this.selectedDate.getDate()+d);this.selectDate(c)},moveDateMonthBy:function(d){var c=new Date(this.selectedDate.getFullYear(),this.selectedDate.getMonth()+d,this.selectedDate.getDate());if(c.getMonth()==this.selectedDate.getMonth()+d+1){c.setDate(0)}this.selectDate(c)},moveMonthTo:function(c){var d=new Date(this.currentMonth.getFullYear(),c,this.currentMonth.getDate());this.selectMonth(d)},moveMonthBy:function(c){var d=new Date(this.currentMonth.getFullYear(),this.currentMonth.getMonth()+c,this.currentMonth.getDate());this.selectMonth(d)},moveYearTo:function(d){var c=new Date(d,this.currentMonth.getMonth(),this.currentMonth.getDate());this.selectMonth(c)},bindToObj:function(d){var c=this;return function(){return d.apply(c,arguments)}},bindMethodsToObj:function(){for(var c=0;c<arguments.length;c++){this[arguments[c]]=this.bindToObj(this[arguments[c]])}},indexFor:function(e,d){for(var c=0;c<e.length;c++){if(d==e[c]){return c}}},monthNum:function(c){return this.indexFor(this.month_names,c)},shortMonthNum:function(c){return this.indexFor(this.short_month_names,c)},shortDayNum:function(c){return this.indexFor(this.short_day_names,c)},daysBetween:function(d,c){d=Date.UTC(d.getFullYear(),d.getMonth(),d.getDate());c=Date.UTC(c.getFullYear(),c.getMonth(),c.getDate());return(c-d)/86400000},changeDayTo:function(c,d,e){var f=e*(Math.abs(d.getDay()-c-(e*7))%7);return new Date(d.getFullYear(),d.getMonth(),d.getDate()+f)},rangeStart:function(c){return this.changeDayTo(this.start_of_week,new Date(c.getFullYear(),c.getMonth()),-1)},rangeEnd:function(c){return this.changeDayTo((this.start_of_week+6)%7,new Date(c.getFullYear(),c.getMonth()+1,0),1)},isFirstDayOfWeek:function(c){return c.getDay()==this.start_of_week},isLastDayOfWeek:function(c){return c.getDay()==(this.start_of_week+6)%7},adjustDays:function(e){var d=[];for(var c=0;c<e.length;c++){d[c]=e[(c+this.start_of_week)%7]}return d}};a.fn.date_input=function(c){return this.each(function(){new b(this,c)})};a.date_input={initialize:function(c){a("input.date_input").date_input(c)}};return b})(jQuery);